{%- extends "page.html" -%}

{%- block stylesheet -%}
  <link rel="stylesheet" href='{{static_url("css/home.css")}}' type="text/css"/>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
{%- endblock -%}

{%- block main -%}
{%- import "macros/table/config/home.jinja" as config %}
{%- import "macros/table/variables.jinja" as vars %}
{%- set pagetype = vars.pagetype_home %}

{%- from "macros/table/table.jinja" import tables with context %}

{% macro description() %}
  <p>You can configure your existing JupyterLabs by expanding the corresponding table row.</p>
{% endmacro %}

{{ tables(
  config.frontend_config,
  description
) }}
{%- endblock -%}


{%- block script -%}
{%- import "macros/table/config/home.jinja" as config %}
{%- import "macros/table/variables.jinja" as vars %}
{%- set pagetype = vars.pagetype_home %}

{%- import "macros/svgs.jinja" as svg -%}
{%- set table_rows = {} %}

{%- for active in [True, False] %}
  {%- for spawner in spawners %}
    {% if (spawner.name in user.spawners.keys() and user.spawners.get(spawner.name).active == active) or not active %}
      {%- if ( spawner != None and spawner.user_options != None and spawner.user_options.get("name", false) ) %}
        {%- set _ = table_rows.update({spawner.name: frontendCollection.get("decrypted_user_options").get(spawner.name, spawner.user_options)}) %}
      {%- endif %}
    {%- endif %}
  {%- endfor %}
{%- endfor %}

<script>
  /* Jinja dependent functions:
  * Define get funtions to enable the use of jinja variables (supplied by the backend) within the JavaScript classes (otherwise they are not reachable)
  */
  function getFrontendCollection() {
    return {{ frontendCollection | tojson}} || {};
  }
  function getTableRows() {
    return {{ table_rows | tojson }} || {};
  }
  function getFirstRowId() {
    return "{{ vars.first_row_id }}";
  }
  {%- include "macros/table/config/home_js.jinja" %}
  function getSvg(name) {
    if ( name === "check" ) {
      return `{{ svg.check_svg | safe }}`;
    } else if ( name === "copy" ) {
      return `{{ svg.copy_svg | safe }}`;
    } else if ( name === "failed" ) {
      return `{{ svg.failed_svg | safe }}`;
    } else if ( name === "link" ) {
      return `{{ svg.link_svg | safe }}`;
    } else if ( name === "delete" ) {
      return `{{ svg.delete_svg | safe }}`;
    } else if ( name === "plus" ) {
      return `{{ svg.plus_svg | safe }}`;
    } else if ( name === "info" ) {
      return `{{ svg.info_svg | safe }}`;
    } else if ( name === "start" ) {
      return `{{ svg.start_svg | safe }}`;
    } else if ( name === "stop" ) {
      return `{{ svg.stop_svg | safe }}`;
    } else if ( name === "na" ) {
      return `{{ svg.na_svg | safe }}`;
    } else if ( name === "rtc" ) {
      return `{{ svg.rtc_svg | safe }}`;
    } else if ( name === "link" ) {
      return `{{ svg.link_svg | safe }}`;
    } else if ( name === "servers" ) {
      return `{{ svg.servers_svg | safe }}`;
    } else if ( name === "users" ) {
      return `{{ svg.users_svg | safe }}`;
    } else if ( name === "warning" ) {
      return `{{ svg.warning_svg | safe }}`;
    } else if ( name === "logs" ) {
      return `{{ svg.logs_svg | safe }}`;
    } else if ( name === "info_filled" ) {
      return `{{ svg.info_filled_svg | safe }}`;
    } else if ( name === "announcement" ) {
      return `{{ svg.announcement_svg | safe }}`;
    } else if ( name === "retry" ) {
      return `{{ svg.retry_svg | safe }}`;
    } else if ( name === "share" ) {
      return `{{ svg.share_svg | safe }}`;
    } else if ( name === "reset" ) {
      return `{{ svg.reset_svg | safe }}`;
    } else if ( name === "save" ) {
      return `{{ svg.save_svg | safe }}`;
    } else if ( name === "open" ) {
      return `{{ svg.open_svg | safe }}`;
    } else if ( name === "settings" ) {
      return `{{ svg.settings_svg | safe }}`;
    }
  }
  function getAuthState() {
    return {{ auth_state | default({}) | tojson }};
  }
  function getWorkshopOptions() {
    return {{ workshop_options | default({}) | tojson }};
  }
  function isFirstRow(rowId) {
    return rowId === "{{ vars.first_row_id }}";
  }

  function getSpawnerUserOptions() {
    {% set spawner_map = {} %}
    {% for spawner in spawners %}
      {%- if spawner.user_options and spawner.user_options.get("name", false) %}
        {% set _ = spawner_map.update({ spawner.name: spawner.user_options }) %}
      {%- endif %}
    {% endfor %}
    return {{ spawner_map | tojson | safe }};
  }

  function getSpawner(rowId) {
    const spawnerMap = {};
    {%- for spawner_ in spawners %}
      {%- if spawner_.user_options and spawner_.name %}
        {%- if user.spawners.get(spawner_.name) and user.spawners.get(spawner_.name).user_options.get("option") %}
          {%- set spawner = user.spawners.get(spawner_.name) %}
        {%- else %}
          {%- set spawner = spawner_ %}
        {%- endif %}
        {%- set events = spawner.events if spawner.events is iterable and spawner.events is not string else [] %}
        {%- set last_event = events | last %}
        {%- set progress = 0 %}
        {%- if spawner.ready %}
          {%- set progress = 100 %}
        {%- elif spawner.active and last_event is mapping %}
          {%- set progress = last_event.get("progress", 0) %}
        {%- endif %}
        spawnerMap["{{ spawner.name }}"] = {
          decrypted_user_options: {{ frontendCollection.get("decrypted_user_options").get(spawner.name, spawner.user_options) | tojson }},
          user_options: {{ spawner.user_options | tojson }},
          active: {{ spawner.active | tojson }},
          ready: {{ spawner.ready | tojson }},
          pending: {{ (spawner.pending if spawner.pending else false) | tojson }},
          failed: {{ spawner.failed | default(false) | tojson }},
          events: {{ events | default([]) | tojson }},
          last_event: {{ last_event | default({}) | tojson }},
          progress: {{ progress }}
        };
      {%- endif %}
    {%- endfor %}
    return spawnerMap[rowId] || {};
  }


  function pageType(name) {
    if ( name === "home" ) {
      return "{{ vars.pagetype_home }}";
    } else if ( name === "share" ) {
      return "{{ vars.pagetype_share }}";
    } else if ( name === "spawn" ) {
      return "{{ vars.pagetype_spawn }}";
    } else if ( name === "start" ) {
      return "{{ vars.pagetype_start }}";
    } else if ( name === "workshop" ) {
      return "{{ vars.pagetype_workshop }}";
    } else if ( name === "workshopmanager" ) {
      return "{{ vars.pagetype_workshopmanager }}";
    } else {
      return "{{ pagetype }}";
    }
  }
</script>


{%- include "macros/table/elements_js.jinja" with context %}

<script src="{{static_url("js/table_elements.js") }}" type="text/javascript" charset="utf-8"></script>
<script src="{{static_url("js/table.js") }}" type="text/javascript" charset="utf-8"></script>

{%- endblock %}
